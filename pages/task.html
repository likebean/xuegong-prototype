<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日程</title>
    <link rel="stylesheet" href="styles/common.css">
    <style>
        body {
            padding: 0;
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* 日历部分样式 */
        .calendar-wrapper {
            background: var(--bg-card);
            padding: var(--spacing-md) var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .calendar-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
        }

        .calendar-nav-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .calendar-nav-btn:active {
            background: var(--bg-color);
        }

        .calendar-month-year {
            font-size: 14px;
            margin: 0 var(--spacing-md);
            color: var(--text-primary);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            margin-bottom: var(--spacing-sm);
        }

        .calendar-weekday {
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            padding: var(--spacing-xs) 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-gap: var(--spacing-xs);
        }

        .calendar-day {
            text-align: center;
            height: 36px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
        }

        .calendar-day-number {
            font-size: 14px;
            line-height: 1;
            color: var(--text-primary);
        }

        .calendar-day.disabled .calendar-day-number {
            color: var(--text-tertiary);
        }

        .calendar-day.today {
            background: var(--primary-light);
        }

        .calendar-day.today .calendar-day-number {
            color: var(--primary-color);
            font-weight: 500;
        }

        .calendar-day.selected {
            background: var(--primary-color);
        }

        .calendar-day.selected .calendar-day-number {
            color: var(--text-white);
        }

        .calendar-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--primary-color);
        }

        .calendar-day.selected.has-event::after {
            background: var(--text-white);
        }

        /* 任务标签页样式 */
        .task-container {
            padding: 0 var(--spacing-md);
        }
        
        .task-tabs {
            display: flex;
            margin: 0 calc(-1 * var(--spacing-md)) var(--spacing-lg);
            background: var(--bg-card);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .task-tab {
            flex: 1;
            text-align: center;
            padding: var(--spacing-sm) 0;
            font-size: 14px;
            color: var(--text-secondary);
            position: relative;
            cursor: pointer;
        }

        .task-tab.active {
            color: var(--primary-color);
            font-weight: 500;
        }

        .task-tab.active::after {
            content: '';
            position: absolute;
            bottom: -9px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background: var(--primary-color);
            border-radius: 1px;
        }

        .task-count {
            display: inline-block;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            background: var(--warning);
            color: var(--text-white);
            border-radius: 8px;
            font-size: 12px;
            line-height: 16px;
            text-align: center;
            margin-left: 4px;
        }

        .task-list {
            margin: 0 calc(-1 * var(--spacing-md));
        }

        .task-item {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .task-item:active {
            background: var(--bg-color);
        }

        .task-header {
            display: flex;
            align-items: center;
            padding: var(--spacing-lg);
        }

        .task-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--primary-light);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-md);
        }

        .task-icon.warning {
            background: rgba(255, 163, 0, 0.1);
            color: var(--warning);
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
        }

        .task-meta {
            display: flex;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .task-status {
            margin-left: auto;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            background: var(--primary-light);
            color: var(--primary-color);
        }

        .task-status.warning {
            background: rgba(255, 163, 0, 0.1);
            color: var(--warning);
        }

        .task-detail {
            padding: 0 var(--spacing-lg) var(--spacing-lg) calc(40px + var(--spacing-lg) * 2);
            font-size: 14px;
            color: var(--text-secondary);
            display: none;
        }

        .task-item.expanded .task-detail {
            display: block;
        }

        .student-list {
            margin-top: var(--spacing-md);
            background: var(--bg-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .student-item {
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-name {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .talk-button {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .talk-button:active {
            transform: scale(0.95);
            opacity: 0.9;
        }

        .task-description {
            margin-bottom: var(--spacing-md);
            line-height: 1.5;
        }

        .action-buttons {
            margin-top: var(--spacing-md);
            display: flex;
            justify-content: flex-end;
        }

        .meta-divider {
            margin: 0 var(--spacing-xs);
            color: var(--border-color);
        }

        .floating-button {
            position: fixed;
            right: var(--spacing-lg);
            bottom: var(--spacing-lg);
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: var(--primary-color);
            color: var(--text-white);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .floating-button:active {
            transform: scale(0.95);
        }

        /* 新建谈话表单弹窗样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: flex-end;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            width: 100%;
            background: var(--bg-card);
            border-radius: 16px 16px 0 0;
            padding: var(--spacing-lg);
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            color: var(--text-primary);
            background: var(--bg-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .submit-button {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-button:active {
            background: var(--primary-dark);
            transform: scale(0.98);
        }
        
        /* 学生搜索相关样式 */
        .search-container {
            position: relative;
            margin-bottom: var(--spacing-md);
        }
        
        .search-input {
            width: 100%;
            padding: var(--spacing-md);
            padding-left: 36px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            color: var(--text-primary);
            background: var(--bg-color);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }
        
        .student-results {
            margin-top: var(--spacing-sm);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 10;
            position: absolute;
            width: 100%;
            box-shadow: var(--shadow-sm);
        }
        
        .student-results.show {
            display: block;
        }
        
        .student-result-item {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .student-result-item:last-child {
            border-bottom: none;
        }
        
        .student-result-item:hover {
            background: var(--bg-color);
        }
        
        .student-result-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
        }
        
        .student-result-info {
            flex: 1;
        }
        
        .student-result-name {
            font-weight: 500;
            color: var(--text-primary);
            display: block;
        }
        
        .student-result-id {
            font-size: 12px;
            color: var(--text-tertiary);
        }
        
        .selected-student {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(232, 255, 243, 1);
            border-radius: 8px;
            margin-top: 8px;
            border: 1px solid rgba(7, 193, 96, 0.2);
            min-height: 48px;
        }
        
        .selected-student-info {
            font-weight: 500;
            color: #07C160;
            font-size: 16px;
        }
        
        .remove-student {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 20px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-left: 8px;
        }
        
        .remove-student:active {
            background: rgba(0, 0, 0, 0.05);
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: var(--spacing-md);
        }
    </style>
</head>
<body>
    <!-- 日历部分 -->
    <div class="calendar-wrapper">
        <div class="calendar-header">
            <h2 class="calendar-title">谈心谈话日历</h2>
            <div class="calendar-nav">
                <button class="calendar-nav-btn" id="prevMonth">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <span class="calendar-month-year" id="currentMonthYear">2023年12月</span>
                <button class="calendar-nav-btn" id="nextMonth">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
        <div class="calendar-weekdays">
            <div class="calendar-weekday">日</div>
            <div class="calendar-weekday">一</div>
            <div class="calendar-weekday">二</div>
            <div class="calendar-weekday">三</div>
            <div class="calendar-weekday">四</div>
            <div class="calendar-weekday">五</div>
            <div class="calendar-weekday">六</div>
        </div>
        <div class="calendar-days" id="calendarDays">
            <!-- 日历天数将通过 JavaScript 动态生成 -->
        </div>
    </div>

    <div class="task-container">
        <!-- 任务标签页 -->
        <div class="task-tabs">
            <div class="task-tab active" data-type="all">全部谈话</div>
            <div class="task-tab" data-type="todo">待处理<span class="task-count">2</span></div>
            <div class="task-tab" data-type="done">已完成</div>
        </div>

        <!-- 任务列表 -->
        <div class="task-list" id="taskList">
            <!-- 任务项将通过 JavaScript 动态生成 -->
        </div>
    </div>

    <!-- 悬浮按钮 -->
    <div class="floating-button" id="addTaskButton">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </div>

    <!-- 新建谈话表单弹窗 -->
    <div class="modal" id="newTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">新建谈心谈话日程</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <form id="newTalkForm">
                <div class="form-group">
                    <label class="form-label">选择学生</label>
                    <div class="search-container" id="searchContainer">
                        <div class="search-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </div>
                        <input type="text" class="search-input" id="studentSearch" placeholder="输入姓名或学号搜索">
                        <div class="student-results" id="studentResults"></div>
                    </div>
                    <div class="selected-student" id="selectedStudent" style="display: none;">
                        <div class="selected-student-info"></div>
                        <button type="button" class="remove-student" id="removeStudent">&times;</button>
                    </div>
                    <input type="hidden" id="studentId" name="studentId">
                    <input type="hidden" id="studentName" name="studentName">
                </div>
                <div class="form-group">
                    <label class="form-label">谈话主题</label>
                    <select class="form-control" id="talkTheme" required>
                        <option value="">请选择谈话主题</option>
                        <option value="学业问题">学业问题</option>
                        <option value="心理辅导">心理辅导</option>
                        <option value="就业指导">就业指导</option>
                        <option value="日常关心">日常关心</option>
                        <option value="其他问题">其他问题</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">谈话日期</label>
                    <input type="date" class="form-control" id="talkDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">谈话时间</label>
                    <input type="time" class="form-control" id="talkTime" required>
                </div>
                <div class="form-group">
                    <label class="form-label">谈话地点</label>
                    <input type="text" class="form-control" id="talkLocation" placeholder="请输入谈话地点" required>
                </div>
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <textarea class="form-control" id="talkNote" rows="3" placeholder="请输入备注信息"></textarea>
                </div>
                <button type="submit" class="submit-button">保存</button>
            </form>
        </div>
    </div>

    <script>
        // 模拟任务数据
        const tasks = [
            {
                id: '1001',
                title: '学业预警学生谈话',
                type: 'warning',
                status: '待处理',
                deadline: '今天 14:30',
                students: ['张三'],
                description: '需要与学业预警学生进行谈话，了解学习困难，制定改进计划。'
            },
            {
                id: '1004',
                title: '学业困难学生谈话',
                type: 'warning',
                status: '待处理',
                deadline: '明天 10:00',
                students: ['赵六'],
                description: '与学生讨论最近学业表现下滑的原因，提供学习方法指导。'
            },
            {
                id: '1005',
                title: '日常关心谈话',
                type: 'normal',
                status: '已完成',
                deadline: '昨天 15:30',
                students: ['孙七'],
                description: '定期关心学生生活学习情况，了解是否有困难需要帮助。'
            }
        ];

        // 模拟学生数据
        const studentsData = [
            { id: '2020001', name: '张三', class: '计算机2001', avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=张三' },
            { id: '2020002', name: '李四', class: '计算机2001', avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=李四' },
            { id: '2020003', name: '王五', class: '计算机2001', avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=王五' },
            { id: '2020004', name: '赵六', class: '计算机2002', avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=赵六' },
            { id: '2020005', name: '孙七', class: '计算机2002', avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=孙七' },
            { id: '2020006', name: '周八', class: '软件工程2001', avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=周八' },
            { id: '2020007', name: '吴九', class: '软件工程2001', avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=吴九' },
            { id: '2020008', name: '郑十', class: '软件工程2002', avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=郑十' },
            { id: '2020009', name: '刘一', class: '人工智能2001', avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=刘一' },
            { id: '2020010', name: '陈二', class: '人工智能2001', avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=陈二' }
        ];

        // 渲染任务列表
        function renderTaskList(data = tasks) {
            const listElement = document.getElementById('taskList');
            
            // 展开学生谈话任务，为每个学生创建单独的任务项
            const expandedTasks = [];
            
            data.forEach(task => {
                if (task.title.includes('谈话') && task.students && task.students.length > 1) {
                    // 为每个学生创建单独的任务项
                    task.students.forEach(student => {
                        expandedTasks.push({
                            ...task,
                            id: `${task.id}_${student}`,
                            students: [student], // 只包含单个学生
                            isSubTask: true
                        });
                    });
                } else {
                    expandedTasks.push(task);
                }
            });
            
            listElement.innerHTML = expandedTasks.map(task => {
                // 查找学生头像
                const studentName = task.students[0];
                const studentData = studentsData.find(s => s.name === studentName);
                const avatarUrl = studentData ? studentData.avatar : '';
                
                return `
                <div class="task-item" onclick="toggleTaskDetail(this)" data-id="${task.id}">
                    <div class="task-header">
                        ${avatarUrl ? 
                            `<img src="${avatarUrl}" alt="${studentName}" class="student-avatar">` : 
                            `<div class="task-icon ${task.type === 'warning' ? 'warning' : ''}">
                                ${getTaskIcon(task.type)}
                            </div>`
                        }
                        <div class="task-content">
                            <div class="task-title">${task.title}${task.isSubTask ? ' - ' + task.students[0] : ''}</div>
                            <div class="task-meta">
                                <span>${task.students[0]}</span>
                                <span class="meta-divider">|</span>
                                <span>${task.deadline}</span>
                            </div>
                        </div>
                        <div class="task-status ${task.type === 'warning' ? 'warning' : ''}">${task.status}</div>
                    </div>
                    <div class="task-detail">
                        ${task.description}
                        <div class="action-buttons">
                            <button class="talk-button" onclick="openStudentDetail('${task.students[0]}', event)">发起谈话</button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // 获取任务图标
        function getTaskIcon(type) {
            if (type === 'warning') {
                return `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                `;
            }
            return `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            `;
        }

        // 切换任务详情
        function toggleTaskDetail(element) {
            element.classList.toggle('expanded');
        }

        // 打开学生详情页面并发起谈心谈话
        function openStudentDetail(studentName, event) {
            event.stopPropagation(); // 阻止事件冒泡
            
            // 跳转到学生详情页
            window.location.href = `student-detail.html?name=${encodeURIComponent(studentName)}&action=talk`;
        }

        // 初始化日历
        function initCalendar() {
            const today = new Date();
            let currentMonth = today.getMonth();
            let currentYear = today.getFullYear();
            
            // 更新日历标题
            function updateCalendarTitle() {
                const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
                document.getElementById('currentMonthYear').textContent = `${currentYear}年${monthNames[currentMonth]}`;
            }
            
            // 生成日历天数
            function generateCalendarDays() {
                const daysContainer = document.getElementById('calendarDays');
                daysContainer.innerHTML = '';
                
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayIndex = firstDay.getDay(); // 0 是星期日
                
                // 添加上个月的天数
                for (let i = 0; i < startDayIndex; i++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day disabled';
                    daysContainer.appendChild(dayElement);
                }
                
                // 添加当前月的天数
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'calendar-day-number';
                    dayNumber.textContent = i;
                    dayNumber.setAttribute('data-date', i); // 添加日期属性用于后续查找
                    dayElement.appendChild(dayNumber);
                    
                    // 检查是否为今天
                    if (currentMonth === today.getMonth() && currentYear === today.getFullYear() && i === today.getDate()) {
                        dayElement.classList.add('today');
                    }
                    
                    // 模拟一些有事件的日子
                    if ((i === 15 || i === 16 || i === 7) && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                        dayElement.classList.add('has-event');
                    }
                    
                    // 添加点击事件
                    dayElement.addEventListener('click', function() {
                        // 移除之前的选中状态
                        document.querySelectorAll('.calendar-day.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                        
                        // 添加选中状态
                        this.classList.add('selected');
                        
                        // 显示该日期的任务
                        filterTasksByDate(new Date(currentYear, currentMonth, i));
                    });
                    
                    daysContainer.appendChild(dayElement);
                }
            }
            
            // 按日期筛选任务
            function filterTasksByDate(date) {
                // 这里应该根据日期筛选任务列表
                // 简单模拟一下筛选效果
                const day = date.getDate();
                let filtered = tasks;
                
                if (day === 15) {
                    filtered = tasks.filter(task => task.id === '1001');
                } else if (day === 16) {
                    filtered = tasks.filter(task => task.id === '1004');
                } else if (day === 7) {
                    filtered = tasks.filter(task => task.id === '1005');
                } else {
                    filtered = [];
                }
                
                renderTaskList(filtered);
            }
            
            // 切换上个月
            document.getElementById('prevMonth').addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateCalendarTitle();
                generateCalendarDays();
            });
            
            // 切换下个月
            document.getElementById('nextMonth').addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                updateCalendarTitle();
                generateCalendarDays();
            });
            
            // 初始化
            updateCalendarTitle();
            generateCalendarDays();
        }
        
        // 新建任务弹窗相关
        function initTaskModal() {
            const modal = document.getElementById('newTaskModal');
            const addTaskButton = document.getElementById('addTaskButton');
            const closeButton = document.getElementById('closeModal');
            const form = document.getElementById('newTalkForm');
            
            // 显示弹窗
            addTaskButton.addEventListener('click', function() {
                modal.classList.add('show');
            });
            
            // 关闭弹窗
            closeButton.addEventListener('click', function() {
                modal.classList.remove('show');
            });
            
            // 点击弹窗外部区域关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
            
            // 学生搜索功能
            const studentSearch = document.getElementById('studentSearch');
            const studentResults = document.getElementById('studentResults');
            const selectedStudent = document.getElementById('selectedStudent');
            const selectedStudentInfo = selectedStudent.querySelector('.selected-student-info');
            const removeStudentBtn = document.getElementById('removeStudent');
            const studentIdInput = document.getElementById('studentId');
            const studentNameInput = document.getElementById('studentName');
            
            // 学生搜索输入事件
            studentSearch.addEventListener('input', function() {
                const searchText = this.value.trim().toLowerCase();
                
                if (searchText.length < 1) {
                    studentResults.innerHTML = '';
                    studentResults.classList.remove('show');
                    return;
                }
                
                // 过滤匹配的学生
                const matchedStudents = studentsData.filter(student => 
                    student.name.toLowerCase().includes(searchText) || 
                    student.id.includes(searchText)
                );
                
                // 显示搜索结果
                if (matchedStudents.length > 0) {
                    studentResults.innerHTML = matchedStudents.map(student => `
                        <div class="student-result-item" data-id="${student.id}" data-name="${student.name}">
                            <img src="${student.avatar}" alt="${student.name}" class="student-result-avatar">
                            <div class="student-result-info">
                                <span class="student-result-name">${student.name}</span>
                                <span class="student-result-id">${student.id} - ${student.class}</span>
                            </div>
                        </div>
                    `).join('');
                    
                    studentResults.classList.add('show');
                    
                    // 添加点击选择学生事件
                    document.querySelectorAll('.student-result-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            const name = this.getAttribute('data-name');
                            selectStudent(id, name);
                        });
                    });
                } else {
                    studentResults.innerHTML = '<div class="student-result-item">未找到匹配的学生</div>';
                    studentResults.classList.add('show');
                }
            });
            
            // 选择学生
            function selectStudent(id, name) {
                const student = studentsData.find(s => s.id === id);
                studentIdInput.value = id;
                studentNameInput.value = name;
                
                // 更新显示选中的学生，包括头像
                if (student && student.avatar) {
                    selectedStudentInfo.innerHTML = `
                        <img src="${student.avatar}" alt="${name}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                        <span>${name} (${id})</span>
                    `;
                } else {
                    selectedStudentInfo.textContent = `${name} (${id})`;
                }
                
                // 显示选中学生，隐藏搜索框
                selectedStudent.style.display = 'flex';
                document.getElementById('searchContainer').style.display = 'none';
            }
            
            // 移除已选学生
            removeStudentBtn.addEventListener('click', function(e) {
                e.preventDefault();
                studentIdInput.value = '';
                studentNameInput.value = '';
                
                // 隐藏选中学生，显示搜索框
                selectedStudent.style.display = 'none';
                document.getElementById('searchContainer').style.display = 'block';
                studentSearch.value = '';
            });
            
            // 点击页面其他区域关闭学生搜索结果
            document.addEventListener('click', function(e) {
                if (!studentSearch.contains(e.target) && !studentResults.contains(e.target)) {
                    studentResults.classList.remove('show');
                }
            });
            
            // 提交表单
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 收集表单数据
                const studentName = document.getElementById('studentName').value;
                const theme = document.getElementById('talkTheme').value;
                const date = document.getElementById('talkDate').value;
                const time = document.getElementById('talkTime').value;
                const location = document.getElementById('talkLocation').value;
                const note = document.getElementById('talkNote').value;
                
                // 验证学生选择
                if (!studentName) {
                    alert('请选择学生');
                    return;
                }
                
                // 转换日期格式
                const dateObj = new Date(`${date}T${time}`);
                const formattedDate = formatDate(dateObj);
                
                // 创建新任务
                const newTask = {
                    id: 'task_' + Date.now(),
                    title: `${theme}谈话`,
                    type: theme.includes('学业') || theme.includes('问题') ? 'warning' : 'normal',
                    status: '待处理',
                    deadline: formattedDate,
                    students: [studentName],
                    description: note || `与${studentName}进行${theme}谈话，地点：${location}`,
                    location: location
                };
                
                // 添加到任务列表
                tasks.unshift(newTask);
                renderTaskList();
                
                // 添加事件标记到日历
                const taskDate = new Date(dateObj);
                const dayElement = document.querySelector(`.calendar-day:not(.disabled) .calendar-day-number[data-date="${taskDate.getDate()}"]`);
                if (dayElement) {
                    dayElement.parentElement.classList.add('has-event');
                }
                
                // 关闭弹窗并重置表单
                modal.classList.remove('show');
                form.reset();
                selectedStudent.style.display = 'none';
            });
        }
        
        // 格式化日期
        function formatDate(date) {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;
            
            if (date.toDateString() === today.toDateString()) {
                return `今天 ${timeStr}`;
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return `明天 ${timeStr}`;
            } else if (date.toDateString() === yesterday.toDateString()) {
                return `昨天 ${timeStr}`;
            } else {
                return `${month}月${day}日 ${timeStr}`;
            }
        }

        // 处理标签页切换
        document.querySelectorAll('.task-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                // 更新标签页状态
                document.querySelectorAll('.task-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');

                // 筛选任务
                const type = e.target.getAttribute('data-type');
                let filtered = tasks;
                if (type === 'todo') {
                    filtered = tasks.filter(task => task.status === '待处理');
                } else if (type === 'done') {
                    filtered = tasks.filter(task => task.status === '已完成');
                }
                renderTaskList(filtered);
            });
        });

        // 初始化
        window.onload = function() {
            renderTaskList();
            initCalendar();
            initTaskModal();
        };
    </script>
</body>
</html> 